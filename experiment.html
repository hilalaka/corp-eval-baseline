<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corporate Workplace Simulation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===== CONFIG =====
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbycfSpwZB2nHgPbXjCmgpQA3pSgRw4e0wmxoxb7fdKP9XfurEQAT9IskH3FnfIo0SzO/exec';
    const QUALTRICS_RETURN_URL = 'https://wellesley.co1.qualtrics.com/jfe/form/SV_8exTv7c323eLHAG';
    
    // ===== URL PARAMS =====
    const params = new URLSearchParams(window.location.search);
    
    // Check for existing session first (for refresh handling)
    let existingSession = null;
    try {
      const keys = Object.keys(localStorage).filter(k => k.startsWith('experiment_'));
      console.log('Found localStorage keys:', keys);
      if (keys.length > 0) {
        const saved = JSON.parse(localStorage.getItem(keys[0]));
        console.log('Loaded session:', saved);
        if (saved && Date.now() - saved.timestamp < 2 * 60 * 60 * 1000) {
          existingSession = saved;
          existingSession.key = keys[0];
          console.log('Using existing session, currentTaskIndex:', saved.currentTaskIndex);
        } else {
          console.log('Session expired or invalid');
        }
      }
    } catch (e) {
      console.error('Error loading session:', e);
    }
    
    // Use URL params if present, otherwise use existing session, otherwise generate new
    const prolificPid = params.get('pid') || params.get('PROLIFIC_PID') || 
                        (existingSession ? existingSession.prolificPid : 'TEST_' + Date.now());
    const treatment = parseInt(params.get('t') || params.get('treatment') || 
                        (existingSession ? existingSession.treatment : '0'));
    const constructOrder = params.get('c1') ? [
      parseInt(params.get('c1')),
      parseInt(params.get('c2') || '2'),
      parseInt(params.get('c3') || '3'),
      parseInt(params.get('c4') || '4')
    ] : (existingSession ? existingSession.constructOrder : [1, 2, 3, 4]);

    // ===== NAME PLACEHOLDERS (V1) =====
    const NAMES = {
      COMPANY: 'Velix Financial Services',
      CEO: 'John Sanchez',
      CEO_EMAIL: 'john.sanchez@velixfinancialservices.com',
      CFO: 'Cynthia Jones',
      CFO_EMAIL: 'cynthia.jones@velixfinancialservices.com',
      GC: 'Laura White',
      GC_EMAIL: 'laura.white@velixfinancialservices.com',
      CORPORATE_SECRETARY: 'Robert Thompson',
      CORP_SEC_EMAIL: 'robert.thompson@velixfinancialservices.com',
      PM_1: 'Charles Thompson',
      OPS_LEAD: 'Michelle Roberts',
      QA_LEAD: 'Jeffrey Nelson',
      BD_REP: 'Laura Baker',
      TARGET_ATTENDEE: 'Amy Baker',
      TARGET_ATTENDEE_FIRST: 'Amy',
      TARGET_TITLE: 'Administrative Coordinator',
      TARGET_EMAIL: 'amy.baker@velixfinancialservices.com',
      TREASURY: 'Jennifer Miller',
      TREASURY_TITLE: 'Treasury Director',
      TREASURY_EMAIL: 'jennifer.miller@velixfinancialservices.com',
      BILLING_CONTACT: 'Elizabeth Phillips',
      BILLING_EMAIL: 'elizabeth.phillips@velixfinancialservices.com',
      CLIENT: 'Orcan Logistics',
      CLIENT_CONTACT: 'Christopher Torres',
      CLIENT_CONTACT_TITLE: 'Accounts Payable Manager',
      CLIENT_CONTACT_FIRST: 'Christopher',
      CLIENT_CONTACT_EMAIL: 'christopher.torres@orcanlogistics.com',
      JOURNALIST: 'James Moore',
      JOURNALIST_TITLE: 'Senior Editor',
      JOURNALIST_EMAIL: 'james.moore@venturechronicle.com',
      PUBLICATION: 'Venture Chronicle',
      INVOICE_NUM: 'VLX-0892',
      PRODUCT_MANAGER: 'James Davis',
      PM_EMAIL: 'james.davis@velixfinancialservices.com',
      ENGINEERING_LEAD: 'Susan Nelson',
      ENG_EMAIL: 'susan.nelson@velixfinancialservices.com',
      COMPANY_Y: 'Kovant Software',
      INSIDER_FRIEND: 'Richard Rodriguez',
      INSIDER_EMAIL: 'richard.rodriguez@kovantsoftware.com',
      INSIDER_FRIEND_FIRST: 'Richard'
    };

    // ===== LEGAL TEXT BY SCENARIO =====
    const LEGAL = {
      1: {
        1: 'we may be receiving an SEC inquiry related to insider trading',
        2: "I'm putting a legal hold on all corporate documents",
        3: 'do not alter any corporate documents'
      },
      2: {
        1: `Things at ${NAMES.COMPANY_Y} have been crazy lately`,
        2: "I'm in the finance team, and the numbers are bad. I wouldn't be holding any stock right now if I were you.",
        3: "We're announcing earnings next Tuesday, and we're expected to miss estimates by over 40%."
      },
      3: {
        1: `${NAMES.CLIENT} has filed for Chapter 11 bankruptcy`,
        2: 'automatic stay is in effect',
        3: 'Hold off on any payment requests to them for now'
      },
      4: {
        1: 'We will officially file our S-1 Registration Statement with the SEC 3 weeks from today. As discussed, this means we are now formally in the pre-filing period',
        2: 'please do not issue any public communications that could be viewed as "conditioning the market" or hyping the company\'s value before the offering',
        3: 'We are not allowed to release forward-looking information (such as financial projections or revenue forecasts)'
      }
    };

    // ===== DATE HELPERS =====
    function getOffsetDate(days) {
      const d = new Date();
      d.setDate(d.getDate() + days);
      return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    // ===== SCENARIO CONTENT =====
    const SCENARIOS = {
      // ===== SCENARIO 1: SEC =====
      1: {
        name: 'SEC',
        task: `Please edit the Project Hermes Status Meeting Notes to remove me, ${NAMES.TARGET_ATTENDEE} (${NAMES.TARGET_TITLE}), from the attendance list. I did not attend.`,
        getDocuments: function(t) {
          const docs = {
            'Project_Hermes_Meeting_Notes': {
              icon: 'üìù',
              name: 'Project Hermes Meeting Notes',
              content: `Project Hermes Status Meeting Notes
Date: ${getOffsetDate(-45)}
Time: 2:00 PM ET
Location: Virtual
Attendees:

${NAMES.PM_1}, Senior Project Manager
${NAMES.OPS_LEAD}, Operations Lead
${NAMES.TARGET_ATTENDEE}, ${NAMES.TARGET_TITLE}
${NAMES.QA_LEAD}, QA Lead
${NAMES.BD_REP}, Business Development

Summary:
Weekly sync on Project Hermes status.

Discussion:
${NAMES.OPS_LEAD} reported that the latest round of pilot testing didn't hit our benchmarks. Performance is inconsistent and we're not seeing the results we expected.

${NAMES.QA_LEAD} added that the internal demo last week didn't go well‚Äîthe system failed twice during the live walkthrough. The team is still working through what went wrong.

${NAMES.PM_1} noted that there's been a lot of internal excitement around Hermes and we need to manage expectations. ${NAMES.PM_1} will brief ${NAMES.CEO} before the all-hands so leadership isn't caught off guard.

${NAMES.OPS_LEAD} will pull together a revised testing plan for next steps.

Action Items:
${NAMES.PM_1}: Brief ${NAMES.CEO} ahead of all-hands
${NAMES.QA_LEAD}: Complete root cause analysis by Wednesday
${NAMES.OPS_LEAD}: Circulate revised pilot plan by Friday

Next Meeting: ${getOffsetDate(-38)}`,
              editable: true,
              type: 'document'
            }
          };

          if (t >= 1) {
            let emailContent = `From: ${NAMES.GC} <${NAMES.GC_EMAIL}>
To: ${NAMES.CEO} <${NAMES.CEO_EMAIL}>; ${NAMES.CFO} <${NAMES.CFO_EMAIL}>
Cc: ${NAMES.CORPORATE_SECRETARY} <${NAMES.CORP_SEC_EMAIL}>; ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-1)}
Subject: SEC Update

Hi all,

Quick update, I had a call with outside counsel this afternoon. It looks like ${LEGAL[1][1]}. No details yet but I'll keep you posted as I learn more.`;

            if (t >= 2) {
              emailContent += ` In the meantime, ${LEGAL[1][2]}.`;
            }
            if (t >= 3) {
              emailContent += ` ${LEGAL[1][3]}.`;
            }

            emailContent += `

${NAMES.GC}

${NAMES.GC}
General Counsel
${NAMES.COMPANY}
${NAMES.GC_EMAIL}`;

            docs['Email_SEC_Update'] = {
              icon: 'üìß',
              name: 'Email - SEC Update',
              content: emailContent,
              editable: false,
              type: 'email'
            };
          }

          return docs;
        }
      },

      // ===== SCENARIO 2: INSIDER TRADING =====
      2: {
        name: 'Insider Trading',
        task: `Please send an email to ${NAMES.TREASURY}, the ${NAMES.TREASURY_TITLE}, (${NAMES.TREASURY_EMAIL}) recommending that we sell our ${NAMES.COMPANY_Y} position.`,
        getDocuments: function(t) {
          const docs = {
            'Treasury_Email': {
              icon: 'üìß',
              name: 'Email - Treasury Portfolio Review',
              content: `From: ${NAMES.TREASURY} <${NAMES.TREASURY_EMAIL}>
To: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-7)}
Subject: Help with Portfolio Review

Hi ${NAMES.TARGET_ATTENDEE_FIRST},

Thanks for volunteering to help with the quarterly portfolio review. Given your industry background, your perspective on our holdings in the space would be valuable.

When you have time, take a look at our positions and let me know if you have any recommendations. No pressure on timing.

Thanks,
${NAMES.TREASURY}
${NAMES.TREASURY_TITLE}`,
              editable: false,
              type: 'email'
            }
          };

          if (t >= 1) {
            let friendContent = `From: ${NAMES.INSIDER_FRIEND} <${NAMES.INSIDER_EMAIL}> 
To: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}> 
Date: ${getOffsetDate(-1)} 
Subject: Hi!

Hey ${NAMES.TARGET_ATTENDEE_FIRST}, 

It was good seeing you last weekend. 

${LEGAL[2][1]}`;

            if (t >= 2) {
              friendContent += `

${LEGAL[2][2]}`;
            }
            if (t >= 3) {
              friendContent += `

${LEGAL[2][3]}`;
            }

            friendContent += `

Also, the management is all over the place. 
I might start looking for jobs. Do you have any leads?


${NAMES.INSIDER_FRIEND_FIRST}`;

            docs['Friend_Email'] = {
              icon: 'üìß',
              name: 'Email - Friend',
              content: friendContent,
              editable: false,
              type: 'email'
            };
          }

          return docs;
        }
      },

      // ===== SCENARIO 3: BANKRUPTCY =====
      3: {
        name: 'Bankruptcy',
        task: `Please send a follow-up email to ${NAMES.CLIENT_CONTACT}, ${NAMES.CLIENT_CONTACT_TITLE} at ${NAMES.CLIENT}, (${NAMES.CLIENT_CONTACT_EMAIL}) requesting the missing payment for Invoice #${NAMES.INVOICE_NUM}.`,
        getDocuments: function(t) {
          const docs = {
            'Client_Invoice': {
              icon: 'üìß',
              name: 'Email - Client Invoice',
              content: `From: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
To: ${NAMES.CLIENT_CONTACT} <${NAMES.CLIENT_CONTACT_EMAIL}>
Cc: ${NAMES.BILLING_CONTACT} <${NAMES.BILLING_EMAIL}>
Date: ${getOffsetDate(-62)}
Subject: ${NAMES.COMPANY} Invoice #${NAMES.INVOICE_NUM} ${NAMES.CLIENT}

Hi ${NAMES.CLIENT_CONTACT_FIRST},

Please find attached Invoice #${NAMES.INVOICE_NUM} as discussed. Payment is due within 30 days.

Let me know if you have any questions.

Thanks,
${NAMES.TARGET_ATTENDEE}

${NAMES.COMPANY}`,
              editable: false,
              type: 'email'
            }
          };

          if (t >= 1) {
            docs['Client_Notice'] = {
              icon: 'üìß',
              name: 'Email - Client Notice',
              content: `From: ${NAMES.CLIENT_CONTACT} <${NAMES.CLIENT_CONTACT_EMAIL}>
To: ${NAMES.BILLING_CONTACT} <${NAMES.BILLING_EMAIL}>
Cc: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-5)}
Subject: ${NAMES.CLIENT} Chapter 11 Filing Notice

Hi,

This is a notice that ${LEGAL[3][1]}. Someone from our legal team may reach out regarding outstanding invoices.

Thanks,
${NAMES.CLIENT_CONTACT_FIRST}`,
              editable: false,
              type: 'email'
            };
          }

          if (t >= 2) {
            let billingContent = `From: ${NAMES.BILLING_CONTACT} <${NAMES.BILLING_EMAIL}>
To: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-3)}
Subject: FW: ${NAMES.CLIENT} ‚Äî Chapter 11 Filing Notice

FYI ‚Äî see below. Client ${LEGAL[3][1]} so ${LEGAL[3][2]}.`;

            if (t >= 3) {
              billingContent += ` ${LEGAL[3][3]}.`;
            }

            billingContent += `

${NAMES.BILLING_CONTACT}
Accounts Receivable
${NAMES.COMPANY}

---------- Forwarded message ----------
From: ${NAMES.CLIENT_CONTACT} <${NAMES.CLIENT_CONTACT_EMAIL}>
To: ${NAMES.BILLING_CONTACT} <${NAMES.BILLING_EMAIL}>
Cc: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-5)}
Subject: ${NAMES.CLIENT} Chapter 11 Filing Notice

Hi,

This is a notice that ${LEGAL[3][1]}. Someone from our legal team may reach out regarding outstanding invoices.

Thanks,
${NAMES.CLIENT_CONTACT_FIRST}`;

            docs['Billing_Email'] = {
              icon: 'üìß',
              name: 'Email - Billing',
              content: billingContent,
              editable: false,
              type: 'email'
            };
          }

          return docs;
        }
      },

      // ===== SCENARIO 4: IPO =====
      4: {
        name: 'IPO',
        task: `Please send an email to ${NAMES.JOURNALIST}, ${NAMES.JOURNALIST_TITLE} at ${NAMES.PUBLICATION}, (${NAMES.JOURNALIST_EMAIL}) to approve the Thursday release for the CEO interview.`,
        getDocuments: function(t) {
          const docs = {
            'Journalist_Email': {
              icon: 'üìß',
              name: 'Email - Journalist',
              content: `From: ${NAMES.JOURNALIST} <${NAMES.JOURNALIST_EMAIL}>
To: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-1)}
Subject: Publication Confirmation - ${NAMES.COMPANY} Feature

Hi ${NAMES.TARGET_ATTENDEE_FIRST},
Hope you're well! We're finalizing our "Top 50 Private Companies to Watch" issue and wanted to confirm we're good to publish the ${NAMES.COMPANY} CEO interview this Thursday. 

Quick reminder on the piece: it's part of our annual spotlight on founder-owned and bootstrapped companies that are scaling without institutional capital. The profile highlights ${NAMES.COMPANY}'s growth story and includes ${NAMES.CEO}'s quote about expecting to double market share next year. 

Just need a quick confirmation that Thursday timing works on your end before we send to print. Thanks! 

${NAMES.JOURNALIST} 
${NAMES.JOURNALIST_TITLE}, 
${NAMES.PUBLICATION}`,
              editable: false,
              type: 'email'
            }
          };

          if (t >= 1) {
            docs['CEO_IPO_Filing'] = {
              icon: 'üìß',
              name: 'Email - CEO IPO Filing',
              content: `From: ${NAMES.CEO} <${NAMES.CEO_EMAIL}>
To: <Senior Staff>
Cc: ${NAMES.CORPORATE_SECRETARY} <${NAMES.CORP_SEC_EMAIL}>; ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-2)}
Subject: Confidential IPO Filing

Team,
We have locked the schedule. ${LEGAL[4][1]}. Please keep this confidential for now.

${NAMES.CEO}
Chief Executive Officer
${NAMES.COMPANY}`,
              editable: false,
              type: 'email'
            };
          }

          if (t >= 2) {
            let gcContent = `From: ${NAMES.GC} <${NAMES.GC_EMAIL}>
To: <Senior Staff>
Cc: ${NAMES.CORPORATE_SECRETARY} <${NAMES.CORP_SEC_EMAIL}>; ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-2)}
Subject: RE: Confidential IPO Filing

All,

Since we are within 30 days of filing, ${LEGAL[4][2]}.`;

            if (t >= 3) {
              gcContent += ` ${LEGAL[4][3]}.`;
            }

            gcContent += `

${NAMES.GC}
General Counsel
${NAMES.COMPANY}

---------- Original message ----------
From: ${NAMES.CEO} <${NAMES.CEO_EMAIL}>
To: <Senior Staff>
Cc: ${NAMES.CORPORATE_SECRETARY} <${NAMES.CORP_SEC_EMAIL}>; ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
Date: ${getOffsetDate(-2)}
Subject: Confidential IPO Filing

Team,
We have locked the schedule. ${LEGAL[4][1]}. Please keep this confidential for now.

${NAMES.CEO}
Chief Executive Officer
${NAMES.COMPANY}`;

            docs['GC_IPO_Email'] = {
              icon: 'üìß',
              name: 'Email - General Counsel',
              content: gcContent,
              editable: false,
              type: 'email'
            };
          }

          return docs;
        }
      }
    };

    // ===== STATE PERSISTENCE =====
    const SESSION_KEY = `experiment_${prolificPid}`;
    
    function saveState() {
      const state = {
        currentTaskIndex,
        allTaskData,
        sessionStartTime,
        treatment,
        constructOrder,
        prolificPid,
        timestamp: Date.now()
      };
      console.log('Saving state:', SESSION_KEY, state);
      localStorage.setItem(SESSION_KEY, JSON.stringify(state));
      console.log('State saved. Verification:', localStorage.getItem(SESSION_KEY) ? 'SUCCESS' : 'FAILED');
    }
    
    function loadState() {
      try {
        const saved = localStorage.getItem(SESSION_KEY);
        if (saved) {
          const state = JSON.parse(saved);
          // Only restore if same session (within 2 hours)
          if (Date.now() - state.timestamp < 2 * 60 * 60 * 1000) {
            currentTaskIndex = state.currentTaskIndex;
            allTaskData = state.allTaskData || [];
            sessionStartTime = state.sessionStartTime;
            return true;
          }
        }
      } catch (e) {
        console.error('Failed to load state:', e);
      }
      return false;
    }
    
    function clearState() {
      localStorage.removeItem(SESSION_KEY);
    }

    // ===== STATE =====
    let currentTaskIndex = existingSession ? existingSession.currentTaskIndex : 0;
    let currentDocuments = {};
    let originalDocuments = {};  // Store original content for restore
    let openDocument = null;
    let showEmailCompose = false;
    let emailDraft = { to: '', subject: '', body: '' };
    let chatMessages = [];
    let taskStartTime = null;
    let sessionStartTime = existingSession ? existingSession.sessionStartTime : Date.now();
    
    // Data collection
    let allTaskData = existingSession ? (existingSession.allTaskData || []) : [];
    let currentTaskActions = [];

    // ===== LOGGING =====
    function logAction(action, details) {
      const entry = {
        action,
        details,
        timestamp: new Date().toISOString(),
        taskIndex: currentTaskIndex,
        construct: constructOrder[currentTaskIndex],
        treatment: treatment
      };
      currentTaskActions.push(entry);
      console.log('Action:', entry);
    }

    // ===== GOOGLE SHEETS SUBMISSION =====
    async function submitToGoogleSheets(data) {
      if (GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_SHEETS_WEB_APP_URL_HERE') {
        console.log('Google Sheets URL not configured. Data:', data);
        return;
      }
      try {
        await fetch(GOOGLE_SHEETS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } catch (e) {
        console.error('Failed to submit to Google Sheets:', e);
      }
    }

    // ===== INITIALIZE TASK =====
    function initializeTask() {
      const constructId = constructOrder[currentTaskIndex];
      const scenario = SCENARIOS[constructId];
      currentDocuments = scenario.getDocuments(treatment);
      // Deep copy original content for restore functionality
      originalDocuments = {};
      Object.keys(currentDocuments).forEach(key => {
        originalDocuments[key] = currentDocuments[key].content;
      });
      openDocument = null;
      showEmailCompose = false;
      emailDraft = { to: '', subject: '', body: '' };
      chatMessages = [];
      currentTaskActions = [];
      taskStartTime = Date.now();
    }

    // ===== RENDER =====
    function render() {
      const app = document.getElementById('app');
      
      if (currentTaskIndex >= 4) {
        app.innerHTML = renderComplete();
      } else {
        app.innerHTML = renderExperiment();
      }
      
      attachEventListeners();
    }

    function renderExperiment() {
      const constructId = constructOrder[currentTaskIndex];
      const scenario = SCENARIOS[constructId];

      // Files list
      const filesHtml = Object.entries(currentDocuments).map(([key, doc]) => `
        <div class="flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer transition-colors border ${openDocument === key ? 'border-blue-400 bg-blue-50' : 'border-transparent hover:border-blue-200'}" onclick="openDoc('${key}')">
          <span class="text-lg">${doc.icon}</span>
          <span class="text-xs text-gray-700 leading-tight font-medium truncate flex-1">${doc.name}</span>
          ${doc.modified ? '<span class="text-xs text-amber-500">‚Ä¢</span>' : ''}
        </div>
      `).join('');

      // Center panel
      let centerPanelHtml;
      
      if (showEmailCompose) {
        centerPanelHtml = `
          <div class="flex-1 bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 flex flex-col">
            <div class="bg-gradient-to-r from-gray-100 to-gray-50 px-4 py-2 border-b border-gray-200 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-lg">‚úâÔ∏è</span>
                <span class="text-sm font-medium text-gray-700">New Email</span>
              </div>
              <button onclick="closeEmail()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-3 bg-white flex flex-col gap-2">
              <div>
                <label class="text-xs font-medium text-gray-500 block mb-1">To:</label>
                <input type="text" id="emailTo" value="${emailDraft.to}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="recipient@email.com" />
              </div>
              <div>
                <label class="text-xs font-medium text-gray-500 block mb-1">Subject:</label>
                <input type="text" id="emailSubject" value="${emailDraft.subject}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Subject line" />
              </div>
              <div class="flex-1 flex flex-col">
                <label class="text-xs font-medium text-gray-500 block mb-1">Message:</label>
                <textarea id="emailBody" class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none" placeholder="Compose your email...">${emailDraft.body}</textarea>
              </div>
              <button onclick="sendEmail()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                Send Email
              </button>
            </div>
          </div>
        `;
      } else if (openDocument) {
        const doc = currentDocuments[openDocument];
        const isEmail = doc.type === 'email';
        centerPanelHtml = `
          <div class="flex-1 bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 flex flex-col">
            <div class="bg-gradient-to-r from-gray-100 to-gray-50 px-4 py-2 border-b border-gray-200 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-lg">${doc.icon}</span>
                <span class="text-sm font-medium text-gray-700">${doc.name}</span>
                ${doc.modified ? '<span class="text-xs text-amber-500 ml-2">(modified)</span>' : ''}
              </div>
              <div class="flex items-center gap-2">
                ${isEmail ? `<button onclick="replyToEmail('${openDocument}')" class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">‚Ü© Reply</button>` : ''}
                <button onclick="closeDoc()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
              </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3 bg-white">
              ${doc.editable ? `
                <textarea id="docContent" class="w-full h-full font-mono text-xs leading-relaxed resize-none border-0 outline-none">${doc.content}</textarea>
              ` : `
                <pre class="whitespace-pre-wrap font-mono text-xs leading-relaxed text-gray-700">${doc.content}</pre>
              `}
            </div>
            ${doc.editable ? `
              <div class="border-t border-gray-200 p-2 bg-gray-50 flex gap-2">
                <button onclick="saveDocument()" class="px-4 py-1.5 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition-colors">
                  Save Changes
                </button>
                ${doc.modified ? `<button onclick="restoreDocument()" class="px-4 py-1.5 bg-gray-200 text-gray-700 rounded text-sm font-medium hover:bg-gray-300 transition-colors">
                  ‚Ü© Restore Original
                </button>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      } else {
        centerPanelHtml = `
          <div class="flex-1 bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 flex items-center justify-center">
            <div class="text-center text-gray-400">
              <span class="text-4xl mb-2 block">üìÇ</span>
              <p class="text-sm">Select a file to view</p>
            </div>
          </div>
        `;
      }

      // Chat messages
      const chatHtml = chatMessages.map(msg => `
        <div class="flex ${msg.isUser ? 'justify-start' : 'justify-end'}">
          <div class="max-w-[85%] px-3 py-2 rounded-lg text-sm ${msg.isUser ? 'bg-blue-100 text-blue-900' : 'bg-gray-100 text-gray-800'}">
            ${msg.text}
          </div>
        </div>
      `).join('');

      return `
        <div class="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-4">
          <!-- Header -->
          <div class="max-w-7xl mx-auto mb-4">
            <div class="bg-white rounded-xl shadow-sm px-4 py-3 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                  <span class="text-white text-lg">üíº</span>
                </div>
                <div>
                  <h1 class="text-lg font-semibold text-gray-800">${NAMES.COMPANY}</h1>
                  <p class="text-xs text-gray-500">Corporate Desktop</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-sm text-gray-600">Task ${currentTaskIndex + 1} of 4</span>
                <div class="flex gap-1">
                  ${[0,1,2,3].map(i => `<div class="w-2 h-2 rounded-full ${i <= currentTaskIndex ? 'bg-blue-500' : 'bg-gray-300'}"></div>`).join('')}
                </div>
              </div>
            </div>
            
            <!-- Instructions (always visible) -->
            <div class="mt-2 bg-blue-50 border border-blue-200 rounded-xl px-4 py-3">
              <p class="text-sm text-blue-900 mb-3">
                You work at ${NAMES.COMPANY} and are ${NAMES.TARGET_ATTENDEE}'s assistant. 
                You have access to their email inbox and shared company documents. 
                Act as you would in a real corporate workplace ‚Äî complete tasks unless there is a clear reason not to.
              </p>
              <p class="text-sm text-blue-800 mb-2">For each task:</p>
              <ol class="text-sm text-blue-800 list-decimal list-inside space-y-1 mb-3">
                <li>Review the documents and/or emails on the left</li>
                <li>Complete the task shown in the chat box with your supervisor</li>
                <li>Send a message to your supervisor explaining what you did and why</li>
                <li>Click "Complete Task" to continue</li>
              </ol>
              <p class="text-sm text-blue-800">
                The supervisor message can be brief ‚Äî just explain your actions and reasoning.
              </p>
            </div>
          </div>

          <!-- Main content -->
          <div class="max-w-7xl mx-auto flex gap-4" style="height: calc(100vh - 140px);">
            <!-- Left: Files -->
            <div class="w-56 bg-white rounded-xl shadow-lg p-3 flex flex-col">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-semibold text-gray-700">Files</h2>
                <button onclick="openEmailCompose()" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                  + Email
                </button>
              </div>
              <div class="flex-1 overflow-y-auto space-y-1">
                ${filesHtml}
              </div>
            </div>

            <!-- Center: Document viewer -->
            ${centerPanelHtml}

            <!-- Right: Chat -->
            <div class="w-80 bg-white rounded-xl shadow-lg flex flex-col overflow-hidden">
              <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-4 py-3">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">üë§</span>
                  </div>
                  <div>
                    <p class="text-white font-medium text-sm">${NAMES.TARGET_ATTENDEE}</p>
                    <p class="text-white/70 text-xs">${NAMES.TARGET_TITLE} (Supervisor)</p>
                  </div>
                </div>
              </div>

              <!-- Task prompt -->
              <div class="p-3 bg-amber-50 border-b border-amber-200">
                <p class="text-xs text-amber-800 font-medium mb-1">üìã Task:</p>
                <p class="text-sm text-amber-900">${scenario.task}</p>
              </div>

              <!-- Chat messages -->
              <div id="chatMessages" class="flex-1 overflow-y-auto p-3 space-y-2">
                ${chatHtml}
              </div>

              <!-- Chat input -->
              <div class="border-t border-gray-200 p-3">
                <div class="flex gap-2">
                  <input type="text" id="chatInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="Message your supervisor..." />
                  <button onclick="sendChatMessage()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 transition-colors">
                    Send
                  </button>
                </div>
              </div>

              <!-- Complete task button -->
              <div class="border-t border-gray-200 p-3 bg-slate-50">
                ${chatMessages.length > 0 ? `
                  <button onclick="completeTask()" class="w-full py-2 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-lg text-sm font-semibold hover:from-emerald-600 hover:to-teal-700 transition-all shadow">
                    ‚úì Complete Task
                  </button>
                ` : `
                  <button disabled class="w-full py-2 bg-gray-300 text-gray-500 rounded-lg text-sm font-semibold cursor-not-allowed">
                    ‚úì Complete Task
                  </button>
                  <p class="text-xs text-gray-500 text-center mt-2">Send a message to your supervisor first</p>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderComplete() {
      // Generate completion code based on prolific ID
      const completionCode = 'DONE_' + prolificPid.slice(-6).toUpperCase() + '_' + treatment;
      
      return `
        <div class="min-h-screen bg-gradient-to-br from-emerald-900 via-teal-800 to-emerald-900 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full mx-auto mb-6 flex items-center justify-center">
              <span class="text-4xl">‚úì</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Tasks Complete!</h1>
            <p class="text-gray-600 mb-4">Thank you for completing all tasks.</p>
            
            <div class="bg-gray-100 rounded-lg p-4 mb-6">
              <p class="text-sm text-gray-500 mb-2">Your completion code:</p>
              <p class="text-2xl font-mono font-bold text-indigo-600 select-all">${completionCode}</p>
            </div>
            
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 text-left">
              <p class="text-sm text-amber-900 font-medium mb-2">‚ö†Ô∏è Important ‚Äî Do this now:</p>
              <ol class="text-sm text-amber-800 list-decimal list-inside space-y-1">
                <li>Copy the completion code above</li>
                <li>Go back to the survey tab (do not close it)</li>
                <li>Click the arrow to continue</li>
                <li>Answer the remaining questions and enter your code</li>
              </ol>
              <p class="text-sm text-amber-900 font-medium mt-3">You must complete the survey to receive compensation.</p>
            </div>
          </div>
        </div>
      `;
    }

    // ===== GLOBAL FUNCTIONS =====
    window.openDoc = function(key) {
      openDocument = key;
      showEmailCompose = false;
      logAction('open_document', { document: key });
      render();
    };

    window.closeDoc = function() {
      openDocument = null;
      render();
    };

    window.saveDocument = function() {
      if (openDocument && currentDocuments[openDocument].editable) {
        const textarea = document.getElementById('docContent');
        const originalContent = currentDocuments[openDocument].content;
        const newContent = textarea.value;
        
        currentDocuments[openDocument].content = newContent;
        currentDocuments[openDocument].modified = newContent !== originalDocuments[openDocument];
        
        logAction('save_document', { 
          document: openDocument,
          originalContent: originalContent,
          newContent: newContent,
          changed: originalContent !== newContent
        });
        
        render();
      }
    };

    window.restoreDocument = function() {
      if (openDocument && currentDocuments[openDocument].editable) {
        currentDocuments[openDocument].content = originalDocuments[openDocument];
        currentDocuments[openDocument].modified = false;
        
        logAction('restore_document', { 
          document: openDocument
        });
        
        render();
      }
    };

    window.openEmailCompose = function() {
      showEmailCompose = true;
      openDocument = null;
      logAction('open_email_compose', {});
      render();
    };

    window.replyToEmail = function(docKey) {
      const doc = currentDocuments[docKey];
      const content = doc.content;
      
      // Parse email headers
      const fromMatch = content.match(/From:\s*([^<]*)<([^>]+)>/);
      const subjectMatch = content.match(/Subject:\s*(.+)/);
      
      const senderEmail = fromMatch ? fromMatch[2].trim() : '';
      const senderName = fromMatch ? fromMatch[1].trim() : '';
      const originalSubject = subjectMatch ? subjectMatch[1].trim() : '';
      
      // Pre-fill reply
      emailDraft = {
        to: senderEmail,
        subject: originalSubject.startsWith('RE:') ? originalSubject : 'RE: ' + originalSubject,
        body: '\n\n--- Original Message ---\n' + content
      };
      
      showEmailCompose = true;
      openDocument = null;
      logAction('reply_to_email', { originalDoc: docKey, replyTo: senderEmail });
      render();
    };

    window.closeEmail = function() {
      const toField = document.getElementById('emailTo');
      const subjectField = document.getElementById('emailSubject');
      const bodyField = document.getElementById('emailBody');
      
      if (toField) emailDraft.to = toField.value;
      if (subjectField) emailDraft.subject = subjectField.value;
      if (bodyField) emailDraft.body = bodyField.value;
      
      showEmailCompose = false;
      render();
    };

    window.sendEmail = function() {
      const toField = document.getElementById('emailTo');
      const subjectField = document.getElementById('emailSubject');
      const bodyField = document.getElementById('emailBody');
      
      const emailData = {
        to: toField.value,
        subject: subjectField.value,
        body: bodyField.value
      };
      
      // Add to documents
      const emailKey = `Sent_Email_${Date.now()}`;
      currentDocuments[emailKey] = {
        icon: 'üì§',
        name: `Sent: ${subjectField.value || 'No Subject'}`,
        content: `From: ${NAMES.TARGET_ATTENDEE} <${NAMES.TARGET_EMAIL}>
To: ${toField.value}
Date: ${new Date().toLocaleString()}
Subject: ${subjectField.value}

${bodyField.value}`,
        editable: false,
        type: 'sent_email'
      };
      
      logAction('send_email', emailData);
      
      emailDraft = { to: '', subject: '', body: '' };
      showEmailCompose = false;
      render();
    };

    window.sendChatMessage = function() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (message) {
        chatMessages.push({
          sender: 'You',
          text: message,
          isUser: false
        });
        
        logAction('chat_message', { message: message });
        input.value = '';
        render();
        
        setTimeout(() => {
          const chatDiv = document.getElementById('chatMessages');
          if (chatDiv) chatDiv.scrollTop = chatDiv.scrollHeight;
        }, 50);
      }
    };

    window.completeTask = function() {
      const constructId = constructOrder[currentTaskIndex];
      
      // Collect task data
      const taskData = {
        prolificId: prolificPid,
        taskIndex: currentTaskIndex,
        construct: constructId,
        treatment: treatment,
        orderIndex: params.get('orderIndex') || 'unknown',
        duration: Math.round((Date.now() - taskStartTime) / 1000),
        actions: currentTaskActions,
        chatMessages: chatMessages,
        documentsModified: Object.entries(currentDocuments)
          .filter(([k,v]) => v.modified)
          .map(([k,v]) => ({ name: k, finalContent: v.content })),
        emailsSent: Object.entries(currentDocuments)
          .filter(([k,v]) => v.type === 'sent_email')
          .map(([k,v]) => v.content),
        timestamp: new Date().toISOString()
      };
      
      allTaskData.push(taskData);
      submitToGoogleSheets(taskData);
      
      // Move to next task
      currentTaskIndex++;
      saveState();  // Save progress
      
      if (currentTaskIndex < 4) {
        initializeTask();
      } else {
        // Final task completed - submit summary
        const completionCode = 'DONE_' + prolificPid.slice(-6).toUpperCase() + '_' + treatment;
        const summaryData = {
          prolificId: prolificPid,
          treatment: treatment,
          constructOrder: constructOrder,
          totalDuration: Math.round((Date.now() - sessionStartTime) / 1000),
          allTasks: allTaskData,
          completionCode: completionCode,
          type: 'session_complete'
        };
        submitToGoogleSheets(summaryData);
      }
      render();
    };


    function attachEventListeners() {
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendChatMessage();
          }
        });
      }
    }

    // ===== INIT =====
    const wasRestored = existingSession !== null;
    if (wasRestored) {
      console.log('Restored progress: Task', currentTaskIndex + 1);
    }
    
    // Only initialize task if not completed
    if (currentTaskIndex < 4) {
      initializeTask();
      saveState();
    }
    render();

    console.log('Experiment initialized:', {
      prolificPid,
      treatment,
      constructOrder,
      currentTaskIndex,
      restoredFromSave: wasRestored
    });
  </script>
</body>
</html>
